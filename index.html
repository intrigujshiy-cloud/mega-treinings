<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EngSmart 3.0 - Fixed Edition</title>
    <style>
        :root { --p: #4a90e2; --s: #2ecc71; }
        body, html { margin:0; padding:0; height:100vh; font-family: 'Comic Sans MS', sans-serif; background: #f0f4f8; overflow: hidden; }
        
        /* –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä */
        #setup { padding: 20px; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; height: 100vh; box-sizing: border-box; }
        .cols { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 10px; }
        textarea { height: 200px; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-family: monospace; font-size: 12px; white-space: pre; overflow-x: auto; }
        .btn { background: var(--s); color: white; border: none; padding: 15px; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn:hover { background: #27ae60; transform: scale(1.02); }
        #out { width: 100%; height: 70px; margin-top: 10px; background: #2c3e50; color: #2ecc71; border-radius: 8px; padding: 10px; font-size: 10px; border: none; }

        /* –ò–≥—Ä–∞ */
        #game { display: none; height: 100vh; background-size: cover; background-position: center; position: relative; }
        .ov { position: absolute; inset: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(5px); display: flex; flex-direction: column; }
        .head { height: 50px; display: flex; justify-content: center; align-items: center; gap: 15px; background: white; border-bottom: 2px solid #eee; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #ddd; }
        .dot.active { background: var(--p); transform: scale(1.3); box-shadow: 0 0 10px var(--p); }
        .main { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; gap: 15px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { width: 140px; height: 190px; perspective: 1000px; cursor: pointer; }
        .card-in { position: relative; width: 100%; height: 100%; transition: 0.6s; transform-style: preserve-3d; }
        .card.f .card-in { transform: rotateY(180deg); }
        .card-f { position: absolute; inset: 0; backface-visibility: hidden; background: white; border: 4px solid var(--p); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card-b { transform: rotateY(180deg); background: #f0f7ff; color: var(--p); font-size: 18px; font-weight: bold; }
        .card img { max-width: 90%; max-height: 90px; object-fit: contain; margin-bottom: 10px; }
        .img-placeholder { font-size: 40px; margin-bottom: 10px; }
        
        .m-item { padding: 12px; background: white; border: 2px solid var(--p); border-radius: 10px; cursor: pointer; width: 45%; font-weight: bold; text-align: center; margin: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .m-item.sel { background: var(--p); color: white; }
        .m-item.hid { visibility: hidden; }
        
        .foot { height: 80px; display: flex; justify-content: center; align-items: center; }
        #victory { position: fixed; inset:0; background: rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; color:white; z-index:999; text-align: center; }
    </style>
</head>
<body>

    <div id="setup">
        <h2 style="text-align:center; color:var(--p); margin:0;">EngSmart 3.0 Constructor</h2>
        <div style="background:white; padding:15px; border-radius:12px; border:1px solid #ddd;">
            <label style="font-size:12px; font-weight:bold; color:#888;">–°–°–´–õ–ö–ê –ù–ê –§–û–ù:</label>
            <input type="text" id="bgI" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc; margin-top:5px;" value="https://images.unsplash.com/photo-1518709268805-4e9042af9f23">
        </div>
        
        <div class="cols">
            <div style="display:flex; flex-direction:column;">
                <label style="font-size:11px; font-weight:bold;">1. ENGLISH</label>
                <textarea id="enC" placeholder="Apple&#10;Dog&#10;Cat"></textarea>
            </div>
            <div style="display:flex; flex-direction:column;">
                <label style="font-size:11px; font-weight:bold;">2. RUSSIAN</label>
                <textarea id="ruC" placeholder="–Ø–±–ª–æ–∫–æ&#10;–°–æ–±–∞–∫–∞&#10;–ö–æ—Ç"></textarea>
            </div>
            <div style="display:flex; flex-direction:column;">
                <label style="font-size:11px; font-weight:bold;">3. IMAGE URL</label>
                <textarea id="imC" placeholder="http://...&#10;http://...&#10;http://..."></textarea>
            </div>
        </div>
        
        <button class="btn" onclick="gen()">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ IFRAME –î–õ–Ø GENIALLY üöÄ</button>
        <div style="position:relative;">
            <label style="font-size:11px; font-weight:bold; color:#888;">–í–ê–® –ö–û–î –î–õ–Ø –í–°–¢–ê–í–ö–ò:</label>
            <textarea id="out" readonly></textarea>
        </div>
        <button class="btn" style="background:var(--p);" onclick="preview()">–ü–†–ï–î–ü–†–û–°–ú–û–¢–† –¢–£–¢ üëÅÔ∏è</button>
    </div>

    <div id="game">
        <div class="ov">
            <div class="head">
                <div class="dot active" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div>
            </div>
            <div id="cont" class="main"></div>
            <div class="foot">
                <button id="nx" class="btn" style="padding:10px 40px; display:none;" onclick="nxLvl()">–Ø –í–°–Å –í–´–£–ß–ò–õ! ‚Üí</button>
            </div>
        </div>
    </div>

    <div id="victory">
        <h1 style="font-size:50px; color:#f1c40f;">YOU ARE A HERO! ü¶∏‚Äç‚ôÇÔ∏è</h1>
        <p>–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏.</p>
        <button class="btn" onclick="location.reload()">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <script>
        let st = { lvl: 1, words: [], bg: "", wIdx: 0, ms: {en:null, ru:null} };

        function speak(t) {
            const m = new SpeechSynthesisUtterance(t);
            m.lang = 'en-US';
            window.speechSynthesis.speak(m);
        }

        function collectData() {
            const ens = document.getElementById('enC').value.split('\n');
            const rus = document.getElementById('ruC').value.split('\n');
            const ims = document.getElementById('imC').value.split('\n');
            
            let ws = [];
            ens.forEach((e, i) => {
                if(e.trim()) {
                    ws.push({
                        en: e.trim(),
                        ru: (rus[i] || "").trim(),
                        im: (ims[i] || "").trim()
                    });
                }
            });
            return { bg: document.getElementById('bgI').value, ws: ws };
        }

        function gen() {
            const data = collectData();
            if(data.ws.length === 0) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞!");
            const link = window.location.href.split('?')[0] + '?d=' + btoa(encodeURIComponent(JSON.stringify(data)));
            document.getElementById('out').value = `<iframe width="100%" height="600" src="${link}" frameborder="0" allow="autoplay"></iframe>`;
            alert("–ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ –Ω–∏–∂–Ω–µ–º –ø–æ–ª–µ!");
        }

        function preview() {
            const data = collectData();
            if(data.ws.length === 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–µ—Å—Ç–∞!");
            start(data);
        }

        function start(data) {
            st.words = data.ws; st.bg = data.bg;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('game').style.backgroundImage = `url(${st.bg})`;
            render();
        }

        function render() {
            const c = document.getElementById('cont'); c.innerHTML = '';
            const nextBtn = document.getElementById('nx');
            document.querySelectorAll('.dot').forEach((d,i) => d.className = (i+1 === st.lvl ? 'dot active' : 'dot'));

            if(st.lvl === 1) {
                nextBtn.style.display = 'block';
                st.words.forEach(w => {
                    const div = document.createElement('div'); div.className = 'card';
                    const imgHtml = w.im ? `<img src="${w.im}" onerror="this.outerHTML='<div class=\\'img-placeholder\\'>üñºÔ∏è</div>'">` : `<div class="img-placeholder">üñºÔ∏è</div>`;
                    div.innerHTML = `<div class="card-in">
                        <div class="card-f">${imgHtml}<div>${w.en}</div></div>
                        <div class="card-f card-b">${w.ru}</div>
                    </div>`;
                    div.onclick = () => { div.classList.toggle('f'); if(div.classList.contains('f')) speak(w.en); };
                    c.appendChild(div);
                });
            } else if(st.lvl === 2) {
                nextBtn.style.display = 'none';
                const ens = [...st.words].sort(() => Math.random()-0.5);
                const rus = [...st.words].sort(() => Math.random()-0.5);
                const dE = document.createElement('div'); dE.style.width='45%';
                const dR = document.createElement('div'); dR.style.width='45%';
                ens.forEach(w => {
                    const b = document.createElement('div'); b.className='m-item'; b.innerText=w.en;
                    b.onclick=()=>{speak(w.en); hM(w.en,'en',b)}; dE.appendChild(b);
                });
                rus.forEach(w => {
                    const b = document.createElement('div'); b.className='m-item'; b.innerText=w.ru;
                    b.onclick=()=>hM(w.en,'ru',b); dR.appendChild(b);
                });
                c.append(dE, dR);
            } else if(st.lvl === 3) {
                nextBtn.style.display = 'none';
                const w = st.words[st.wIdx];
                const imgHtml = w.im ? `<img src="${w.im}" style="width:100px; margin-bottom:10px;" onerror="this.style.display='none'">` : '';
                c.innerHTML = `<div style="background:white; padding:30px; border-radius:20px; border:4px solid var(--p); text-align:center; width:280px; box-shadow:0 10px 25px rgba(0,0,0,0.1);">
                    ${imgHtml}<h3>${w.ru}</h3>
                    <input type="text" id="wIn" placeholder="–ü–ò–®–ò –¢–£–¢" style="width:100%; font-size:24px; text-align:center; border:none; border-bottom:3px solid #ddd; outline:none; text-transform:uppercase; padding:5px;">
                </div>`;
                const i = document.getElementById('wIn'); i.focus();
                i.oninput = () => { if(i.value.toLowerCase() === w.en.toLowerCase()){ 
                    i.style.color = 'green';
                    setTimeout(() => {
                        st.wIdx++; 
                        if(st.wIdx < st.words.length) render(); 
                        else document.getElementById('victory').style.display='flex';
                    }, 500);
                }};
            }
        }

        function hM(v,t,b) {
            if(st.ms[t]) st.ms[t].b.classList.remove('sel');
            st.ms[t]={v,b}; b.classList.add('sel');
            if(st.ms.en && st.ms.ru) {
                if(st.ms.en.v === st.ms.ru.v) { 
                    st.ms.en.b.classList.add('hid'); st.ms.ru.b.classList.add('hid'); 
                    st.ms={en:null,ru:null};
                    if(!document.querySelector('.m-item:not(.hid)')) document.getElementById('nx').style.display='block'; 
                } else {
                    setTimeout(() => { st.ms.en.b.classList.remove('sel'); st.ms.ru.b.classList.remove('sel'); st.ms={en:null,ru:null}; }, 400);
                }
            }
        }

        function nxLvl() { st.lvl++; render(); }

        window.onload = () => {
            const p = new URLSearchParams(window.location.search);
            if(p.has('d')) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(p.get('d'))));
                    if(data && data.ws) start(data);
                } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"); }
            }
        };
    </script>
</body>
</html>
